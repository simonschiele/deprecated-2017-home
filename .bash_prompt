#!/bin/bash

function color.exists() {
    [ ${COLORS[${1:-none}]+isset} ] && return 0 || return 1
}

function color.ps1() {
    ( color.exists ${1:-none} ) && echo -ne "\[${COLORS[${1:-none}]}\]"
}

function es_prompt_status_git() {
    local color=${1:-true}

    if $( LANG=C git rev-parse --is-inside-work-tree 2>/dev/null ) ; then

        # local gitStatus="LANG=C git diff --quiet --ignore-submodules HEAD"
        # local gitStatus="$( LANG=C git status 2>/dev/null )"
        local gitBranch="$( LANG=C git symbolic-ref -q --short HEAD )"
        local gitReflogId="$( LANG=C git reflog --pretty=format:'%h' -1 )"
        local gitLastlogId="$( LANG=C git log --pretty=format:'%h' origin/${gitBranch} -1 )"

        if [ "${gitBranch}" = 'master' ] ; then
            gitBranch=""
        fi

        # if [[ ! ${gitStatus} =~ "working directory clean" ]] ; then
        #    local state="$( color.ps1 red )⚡"
        # fi

        if [[ "${gitReflogId}" != "${gitLastlogId}" ]] ; then
            local ahead="$( color.ps1 yellow )↑"
        fi

        if test -n "${ahead}" || test -n "${state}" ; then
            echo "(${gitBranch}${ahead}${state}$( color.ps1 none ))"
        else
            echo "(${gitBranch}$( color.ps1 green )♥$( color.ps1 none ))"
        fi
    fi
}

function es_prompt() {
    local lastret=$?
    local colors=${1:-true}
    local PS1prompt=" > "
    local PS1error=$( [ ${lastret} -gt 0 ] && echo "${lastret}" )
    local PS1user="${SUDO_USER:-${USER}}"
    local PS1host="\h"
    local PS1path="\w"
    local PS1git=
    local PS1chroot=
    local PS1schroot=${SCHROOT_CHROOT_NAME:+(schroot:$SCHROOT_CHROOT_NAME)}
    local PS1virtualenv=${VIRTUAL_ENV:+(virtualenv:$VIRTUAL_ENV)}
    PS1chroot=${PS1chroot:+(chroot) }

    if ( ${colors} ) ; then
        PS1error=${PS1error:+$( color.ps1 red )${PS1error}$( color.ps1 )}
        PS1path=${PS1path:+$( color.ps1 white_background )${PS1path}$( color.ps1 )}
        PS1path=${PS1path:+$( color.ps1 black )${PS1path}}
        PS1chroot=${PS1chroot:+($( color.ps1 red )chroot$( color.ps1 ))}

        BOOLEAN=(true false)
        IS_SUDO=$( pstree -s "$$" | grep -qi 'sudo' ; echo ${BOOLEAN[$?]} )
        IS_ROOT=$( [ $( id -u ) -eq 0 ] && ! ${IS_SUDO} ; echo ${BOOLEAN[$?]} )
        IS_UID0=$( ${IS_SUDO} || ${IS_ROOT} ; echo ${BOOLEAN[$?]} )
        IS_SSH=$( pstree -s "$$" | grep -qi 'sshd' ; echo ${BOOLEAN[$?]} )

        if ${IS_UID0} ; then
            PS1user=${PS1user:+$( color.ps1 red )${PS1user}$( color.ps1 )}
        fi

        if ${IS_SSH} ; then
            PS1host=${PS1host:+$( color.ps1 red )${PS1host}$( color.ps1 )}
        fi
    fi

    if [ -e ~/.bash_prompt ] && [ -n "$( which timeout )" ] ; then
        PS1git=$( LANG=C timeout 0.1 ~/.bash_prompt "${colors}" )
        local gitret=$?
        if [ $gitret -eq 124 ] ; then
            PS1git="($( color.ps1 red )git slow$( color.ps1 ))"
        fi
    fi

    PS1error=${PS1error:+[${PS1error}] }
    PS1git=${PS1git:+ ${PS1git}}

    PS1="${PS1error}${PS1chroot}${PS1user}@${PS1host} ${PS1path}${PS1git}${PS1schroot}${PS1virtualenv}${PS1prompt}"
}


if [[ "${0}" != '-bash' ]] && [[ "$( readlink -f "${0}" )" == "$( readlink -f "${BASH_SOURCE[0]}" )" ]] ; then
    # called by source - export PROMPT_COMMAND git prompt if not already set

    # {{{ Colors

    declare -g -A COLORS

    COLORS[none]="\e[0m"
    COLORS[off]="\e[0m"
    COLORS[false]="\e[0m"
    COLORS[normal]="\e[0m"

    # Basic Colors
    COLORS[black]="\e[0;30m"
    COLORS[red]="\e[0;31m"
    COLORS[green]="\e[0;32m"
    COLORS[yellow]="\e[0;33m"
    COLORS[blue]="\e[0;34m"
    COLORS[purple]="\e[0;35m"
    COLORS[cyan]="\e[0;36m"
    COLORS[white]="\e[0;37m"

    # Bold Colors
    COLORS[black_bold]="\e[1;30m"
    COLORS[red_bold]="\e[1;31m"
    COLORS[green_bold]="\e[1;32m"
    COLORS[yellow_bold]="\e[1;33m"
    COLORS[blue_bold]="\e[1;34m"
    COLORS[purple_bold]="\e[1;35m"
    COLORS[cyan_bold]="\e[1;36m"
    COLORS[white_bold]="\e[1;37m"

    # Underline
    COLORS[black_under]="\e[4;30m"
    COLORS[red_under]="\e[4;31m"
    COLORS[green_under]="\e[4;32m"
    COLORS[yellow_under]="\e[4;33m"
    COLORS[blue_under]="\e[4;34m"
    COLORS[purple_under]="\e[4;35m"
    COLORS[cyan_under]="\e[4;36m"
    COLORS[white_under]="\e[4;37m"

    # Background Colors
    COLORS[black_background]="\e[40m"
    COLORS[red_background]="\e[41m"
    COLORS[green_background]="\e[42m"
    COLORS[yellow_background]="\e[43m"
    COLORS[blue_background]="\e[44m"
    COLORS[purple_background]="\e[45m"
    COLORS[cyan_background]="\e[46m"
    COLORS[white_background]="\e[47m"
    COLORS[gray_background]="\e[100m"

    # }}}

    es_prompt_status_git ${1:-true}
else
    # called by source - export PROMPT_COMMAND git prompt if not already set
    if ! ( echo "$PROMPT_COMMAND" | grep -q "es_prompt" ) ; then
        export PROMPT_COMMAND="es_prompt${PROMPT_COMMAND:+ ; ${PROMPT_COMMAND}}"
    fi
fi
